---
title: Сведения об усилении защиты с помощью OpenID Connect
shortTitle: Security hardening with OpenID Connect
intro: OpenID Connect позволяет рабочим процессам обмениваться маркерами краткосрочного действия непосредственно из поставщика облачных служб.
miniTocMaxHeadingLevel: 4
versions:
  fpt: '*'
  ghec: '*'
  ghes: '>=3.5'
type: tutorial
topics:
  - Security
ms.openlocfilehash: 90a2f8c6cb2114f060bfbd0f422cb1ef6dbca604
ms.sourcegitcommit: 4f08a208a0d2e13dc109678750a962ea2f67e1ba
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/06/2022
ms.locfileid: '148192034'
---
{% data reusables.actions.enterprise-beta %} {% data reusables.actions.enterprise-github-hosted-runners %}

## Обзор OpenID Connect

Рабочие процессы {% data variables.product.prodname_actions %} часто применяются для доступа к поставщику облачных служб (например, AWS, Azure, GCP или HashiCorp Vault) с целью развертывания программного обеспечения или использования предоставляемых поставщиком служб. Прежде чем рабочий процесс сможет получить доступ к ресурсам, он должен предоставить поставщику облачных служб учетные данные, например пароль или токен. Эти учетные данные обычно хранятся на {% data variables.product.prodname_dotcom %} в виде секрета, который предоставляется поставщику облачных служб при каждом запуске рабочего процесса. 

Однако для использования жестко заданных секретов необходимо создать учетные данные в поставщике облачных служб, а затем дублировать их на {% data variables.product.prodname_dotcom %} в качестве секрета. 

OpenID Connect (OIDC) предлагает иной подход: вы можете настроить рабочий процесс для запроса кратковременного маркера доступа непосредственно у поставщика облачных служб. Поставщик облачных служб также должен поддерживать OIDC со своей стороны, и необходимо настроить отношение доверия, определяющее, какие рабочие процессы могут запрашивать маркеры доступа. К поставщикам, которые в настоящее время поддерживают OIDC, относятся Amazon Web Services, Azure, Google Cloud Platform, HashiCorp Vault и другие.

### Преимущества использования OIDC

Изменив рабочие процессы для использования токенов OIDC, можно реализовать указанные ниже рекомендации по обеспечению безопасности.

- **Отсутствие облачных секретов**. Вам не нужно дублировать облачные учетные данные в качестве долгосрочных секретов на {% data variables.product.prodname_dotcom %}. Вместо этого можно настроить отношение доверия к OIDC в системе поставщика облачных служб, а затем изменить рабочие процессы для запроса кратковременного маркера доступа у поставщика облачных служб через OIDC. 
- **Управление проверкой подлинности и авторизацией**. Вы получаете более детальный контроль над использованием учетных данных рабочими процессами и можете применять средства проверки подлинности и авторизации поставщика облачных служб для управления доступом к облачным ресурсам.
- **Смена учетных данных**. При использовании OIDC поставщик облачных служб выдает кратковременный маркер доступа, который действителен только для одного задания, после чего его действие автоматически истекает.

### Начало работы с OIDC

На схеме ниже в общем виде представлена интеграция поставщика OIDC {% data variables.product.prodname_dotcom %} с рабочими процессами и поставщиком облачных служб.

![Схема OIDC](/assets/images/help/images/oidc-architecture.png)

1. В системе поставщика облачных служб создайте отношение доверия OIDC между облачной ролью и рабочими процессами {% data variables.product.prodname_dotcom %}, которым требуется доступ к облаку.
2. При каждом выполнении задания поставщик OIDC {% data variables.product.prodname_dotcom %} автоматически создает токен OIDC. Этот токен содержит несколько утверждений для надежной и проверяемой идентификации рабочего процесса, который пытается пройти проверку подлинности.
3. Вы можете включить в задание шаг или действие для запроса этого токена у поставщика OIDC {% data variables.product.prodname_dotcom %} и его представления поставщику облачных служб.
4. После того как поставщик облачных служб успешно проверит утверждения, представленные в токене, он предоставит кратковременный маркер доступа к облаку, который действует только в течение выполнения задания.

## Настройка отношения доверия OIDC с облаком

При настройке доверия облака к поставщику OIDC {% data variables.product.prodname_dotcom %} **необходимо** добавить условия для фильтрации входящих запросов, чтобы ненадежные репозитории или рабочие процессы не могли запрашивать маркеры доступа к облачным ресурсам.

- Перед предоставлением маркера доступа поставщик облачных служб проверяет, соответствуют ли [`subject`](https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims) (субъект) и другие утверждения, используемые для задания условий, в параметрах доверия и в JSON Web Token (JWT) запроса. Поэтому необходимо правильно определять _субъект_ и другие условия в поставщике облачных служб.
- Инструкции по настройке доверия OIDC и синтаксис для задания условий для облачных ролей (с использованием _субъекта_ и других утверждений) зависят от поставщика облачных служб. Некоторые примеры см. в разделе [Примеры утверждений о субъекте](#example-subject-claims).
 
### Основные сведения о токене OIDC

Каждое задание запрашивает токен OIDC у поставщика OIDC {% data variables.product.prodname_dotcom %}, который предоставляет в ответ автоматически созданный токен JSON Web Token (JWT), уникальный для задания рабочего процесса. При выполнении задания токен OIDC предоставляется поставщику облачных служб. Чтобы проверить токен, поставщик облачных служб проверяет, соответствуют ли субъект и другие утверждения токена OIDC условиям, предварительно заданным в определении доверия OIDC облачной роли.

В приведенном ниже примере в токене OIDC используется субъект (`sub`), который ссылается на среду задания с именем `prod` в репозитории `octo-org/octo-repo`.

```yaml
{
  "typ": "JWT",
  "alg": "RS256",
  "x5t": "example-thumbprint",
  "kid": "example-key-id"
}
{
  "jti": "example-id",
  "sub": "repo:octo-org/octo-repo:environment:prod",
  "environment": "prod",
  "aud": "{% ifversion ghes %}https://HOSTNAME{% else %}https://github.com{% endif %}/octo-org",
  "ref": "refs/heads/main",
  "sha": "example-sha",
  "repository": "octo-org/octo-repo",
  "repository_owner": "octo-org",
  "actor_id": "12",
  "repository_visibility": private,
  "repository_id": "74",
  "repository_owner_id": "65",
  "run_id": "example-run-id",
  "run_number": "10",
  "run_attempt": "2",
  "actor": "octocat",
  "workflow": "example-workflow",
  "head_ref": "",
  "base_ref": "",
  "event_name": "workflow_dispatch",
  "ref_type": "branch",
  "job_workflow_ref": "octo-org/octo-automation/.github/workflows/oidc.yml@refs/heads/main",
  "iss": "{% ifversion ghes %}https://HOSTNAME/_services/token{% else %}https://token.actions.githubusercontent.com{% endif %}",
  "nbf": 1632492967,
  "exp": 1632493867,
  "iat": 1632493567
}
```

Просмотреть все утверждения, поддерживаемые поставщиком OIDC {% data variables.product.prodname_dotcom %}, можно в записях `claims_supported` на странице {% ifversion ghes %}`https://HOSTNAME/_services/token/.well-known/openid-configuration`{% else %} https://token.actions.githubusercontent.com/.well-known/openid-configuration{% endif %}.

Токен включает в себя стандартные утверждения об аудитории, издателе и субъекте.

|    Утверждение    | Описание            |
| ----------- | ---------------------- |
| `aud`| _(Аудитория)_ По умолчанию это URL-адрес владельца репозитория, например организации, которой он принадлежит. Это единственное утверждение, которое можно настроить. Пользовательскую аудиторию можно задать с помощью следующей команды из набора средств: [`core.getIDToken(audience)`](https://www.npmjs.com/package/@actions/core/v/1.6.0)          | 
| `iss`| _(Издатель)_ Издатель токена OIDC: {% ifversion ghes %}`https://HOSTNAME/_services/token`{% else %}`https://token.actions.githubusercontent.com`{% endif %}                   | 
| `sub`| _(Субъект)_ Определяет утверждение о субъекте, которое должно проверяться поставщиком облачных служб. Этот параметр необходим для выделения маркеров доступа предсказуемым образом.|

Токен OIDC также включает в себя дополнительные стандартные утверждения:

|    Утверждение    | Описание            |
| ----------- | ---------------------- |
| `alg`| _(Алгоритм)_ Алгоритм, используемый поставщиком OIDC.                    | 
| `exp`| _(Срок действия)_ Определяет время истечения срока действия токена JWT.                    | 
| `iat`| _(Выдан в)_ Время выдачи токена JWT.                   | 
| `jti`| _(Идентификатор токена JWT)_ Уникальный идентификатор токена OIDC.                   | 
| `kid`| _(Идентификатор ключа)_ Уникальный ключ токена OIDC.                   | 
| `nbf`| _(Не ранее)_ Токен JWT недействителен до этого времени.                   | 
| `typ`| _(Тип)_ Описывает тип токена. Это токен JSON Web Token (JWT).                   | 

Токен также включает в себя пользовательские утверждения, предоставляемые {% data variables.product.prodname_dotcom %}.

|    Утверждение    | Описание            |
| ----------- | ---------------------- |
| `actor`| Личная учетная запись, которая инициировала запуск рабочего процесса.                   | 
| `actor_id`| Идентификатор личной учетной записи, которая инициировала запуск рабочего процесса.             |
| `base_ref`| Целевая ветвь запроса на вытягивание в рамках запуска рабочего процесса.                   | 
| `environment`| Имя среды, используемой заданием.                    | 
| `event_name`| Имя события, вызвавшего запуск рабочего процесса.                    | 
| `head_ref`| Исходная ветвь запроса на вытягивание в рамках запуска рабочего процесса.                   | 
| `job_workflow_ref`| Это путь ссылки к многоразовому рабочему процессу, используемому этим заданием. Дополнительные сведения см. в разделе [Использование OpenID Connect с повторно используемыми рабочими процессами](/actions/deployment/security-hardening-your-deployments/using-openid-connect-with-reusable-workflows).                  | 
| `ref`| _(Ссылка)_ Ссылка GIT, активировавшая запуск рабочего процесса.                   | 
| `ref_type`| Тип `ref`, например branch (ветвь).                  | 
| `repository_visibility` | Видимость репозитория, в котором выполняется рабочий процесс. Принимает следующие значения: `internal`, `private`или `public`.                   | 
| `repository`| Репозиторий, из которого запускается рабочий процесс.                   | 
| `repository_id`| Идентификатор репозитория, из которого запускается рабочий процесс.  |
| `repository_owner`| Имя организации, в которой хранится `repository`.                   | 
| `repository_owner_id`| Идентификатор организации, в которой хранится `repository`.            |
| `run_id`| Идентификатор запуска рабочего процесса, активировавшего рабочий процесс.                   | 
| `run_number`| Количество запусков этого рабочего процесса.                   | 
| `run_attempt`| Количество повторных попыток этого запуска рабочего процесса.                    | 
| `workflow`| Имя рабочего процесса.                   | 

### Определение условий доверия для облачных ролей с помощью утверждений OIDC

При использовании OIDC рабочему процессу {% data variables.product.prodname_actions %} требуется токен для доступа к ресурсам поставщика облачных служб. Рабочий процесс запрашивает маркер доступа у поставщика облачных служб, который проверяет сведения в токене JWT. Если конфигурация доверия в JWT соответствует условиям, поставщик облачных служб выдает в ответ рабочему процессу временный маркер, который можно использовать для доступа к ресурсам поставщика облачных служб. Поставщик облачных служб можно настроить так, чтобы он отвечал только на запросы из репозитория определенной организации. Кроме того, можно указать дополнительные условия, как описано ниже.

Утверждения об аудитории и субъекте обычно используются в сочетании друг с другом при задании условий для облачной роли и ресурсов, чтобы ограничить доступ к рабочим процессам GitHub.
- **Аудитория**: по умолчанию используется URL-адрес организации или владельца репозитория. С помощью этого утверждения можно задать условие, согласно которому доступ к облачной роли могут иметь только рабочие процессы определенной организации.
- **Тема**. По умолчанию имеет предопределенный формат и представляет собой объединение некоторых ключевых метаданных рабочего процесса, таких как {% data variables.product.prodname_dotcom %} организации, репозитория, ветви или связанной [`job`](/actions/learn-github-actions/workflow-syntax-for-github-actions#jobsjob_idenvironment) среды. Чтобы узнать, как утверждение о субъекте составляется путем сцепления метаданных, см. в разделе [Примеры утверждений о субъекте](#example-subject-claims).

Если требуются более детализированные условия доверия, можно настроить утверждения издателя (`iss`) и субъекта (`sub`), включенные в JWT. Дополнительные сведения см. в разделе [Настройка утверждений маркеров безопасности HTTP](#customizing-the-token-claims).

Кроме того, в маркере OIDC поддерживается множество дополнительных утверждений, которые можно использовать для установки этих условий. Кроме того, поставщик облачных служб может предусматривать возможность назначения роли маркерам доступа, что позволяет настраивать еще более детализированные разрешения.

{% note %}

**Примечание**. Чтобы управлять тем, как поставщик облачных служб выдает маркеры доступа, **необходимо** определить по крайней мере одно условие, запретив ненадежным репозиториям запрашивать маркеры доступа к облачным ресурсам.

{% endnote %}

### Примеры утверждений о субъекте

В приведенных ниже примерах показано, как использовать субъект в качестве условия и как он составляется путем сцепления метаданных. [Субъект](https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims) использует сведения из [контекста `job`](/actions/learn-github-actions/contexts#job-context) и сообщает поставщику облачных служб, что выполняться могут запросы маркеров доступа только из рабочих процессов, выполняющихся в определенных ветвях и средах. В следующих разделах описаны некоторые распространенные субъекты.

#### Фильтрация определенной среды

Если задание ссылается на среду, утверждение о субъекте включает ее имя.

Вы можете настроить субъект, который отфильтровывает определенное имя [среды](/actions/deployment/using-environments-for-deployment). В этом примере источником запуска рабочего процесса должно быть задание со средой `Production` в репозитории `octo-repo`, принадлежащем организации `octo-org`:

|        |             |
| ------ | ----------- |
| Синтаксис: | `repo:<orgName/repoName>:environment:<environmentName>`      | 
| Пример.| `repo:octo-org/octo-repo:environment:Production`       |

#### Фильтрация событий `pull_request`

Когда рабочий процесс активируется событием запроса на вытягивание, утверждение о субъекте включает строку `pull_request`, но только если задание не ссылается на среду.

Вы можете настроить субъект, который отфильтровывает событие [`pull_request`](/actions/learn-github-actions/events-that-trigger-workflows#pull_request). В этом примере запуск рабочего процесса должен был быть активирован событием `pull_request` в репозитории `octo-repo`, принадлежащем организации `octo-org`:

|        |             |
| ------ | ----------- |
| Синтаксис: | `repo:<orgName/repoName>:pull_request`      | 
| Пример.| `repo:octo-org/octo-repo:pull_request`      |

#### Фильтрация определенной ветви

Утверждение о субъекте содержит имя ветви рабочего процесса, но только если задание не ссылается на среду и если рабочий процесс не активируется событием запроса на вытягивание.

Вы можете настроить субъект, который отфильтровывает определенное имя ветви. В этом примере источником запуска рабочего процесса должна быть ветвь `demo-branch` в репозитории `octo-repo`, принадлежащем организации `octo-org`:

|        |             |
| ------ | ----------- |
| Синтаксис: | `repo:<orgName/repoName>:ref:refs/heads/branchName`      | 
| Пример.| `repo:octo-org/octo-repo:ref:refs/heads/demo-branch`      |

#### Фильтрация определенного тега

Утверждение о субъекте содержит имя тега рабочего процесса, но только если задание не ссылается на среду и если рабочий процесс не активируется событием запроса на вытягивание.

Вы можете создать субъект, который отфильтровывает определенный тег. В этом примере запуск рабочего процесса должен был быть произведен с тегом `demo-tag` в репозитории `octo-repo`, принадлежащем организации `octo-org`:

|        |             |
| ------ | ----------- |
| Синтаксис: | `repo:<orgName/repoName>:ref:refs/tags/<tagName>`      | 
| Пример.| `repo:octo-org/octo-repo:ref:refs/tags/demo-tag`      |

### Настройка субъекта в системе поставщика облачных служб

Чтобы настроить субъект в отношении доверия поставщика облачных служб, необходимо добавить строку субъекта в конфигурацию доверия. В следующих примерах показано, как различные поставщики облачных служб могут принимать один и тот же субъект `repo:octo-org/octo-repo:ref:refs/heads/demo-branch` различными способами:

|        |             |
| ------ | ----------- |
| Amazon Web Services | `"{% ifversion ghes %}HOSTNAME/_services/token{% else %}token.actions.githubusercontent.com{% endif %}:sub": "repo:octo-org/octo-repo:ref:refs/heads/demo-branch"`      | 
| Azure| `repo:octo-org/octo-repo:ref:refs/heads/demo-branch`      |
| Google Cloud Platform| `(assertion.sub=='repo:octo-org/octo-repo:ref:refs/heads/demo-branch')`      |
| Хранилище HashiCorp| `bound_subject="repo:octo-org/octo-repo:ref:refs/heads/demo-branch" `      |

Дополнительные сведения см. в руководствах, перечисленных в разделе [Включение OpenID Connect для поставщика облачных служб](#enabling-openid-connect-for-your-cloud-provider).

## Изменение действий для использования OIDC

Чтобы изменить пользовательские действия для проверки подлинности с помощью OIDC, можно воспользоваться командой `getIDToken()` из набора средств Actions для запроса токена JWT у поставщика OIDC {% data variables.product.prodname_dotcom %}. Дополнительные сведения см. в разделе "Токен OIDC" в [документации по пакету npm](https://www.npmjs.com/package/@actions/core/v/1.6.0).

Для запроса токена JWT можно также использовать команду `curl` и следующие переменные среды:

|        |             |
| ------ | ----------- |
| `ACTIONS_ID_TOKEN_REQUEST_URL` | URL-адрес поставщика OIDC {% data variables.product.prodname_dotcom %}.      | 
| `ACTIONS_ID_TOKEN_REQUEST_TOKEN` | Токен носителя для запроса к поставщику OIDC.      |


Пример:

```shell{:copy}
curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange"
```

### Добавление параметров разрешений

{% data reusables.actions.oidc-permissions-token %}

{% ifversion actions-oidc-hardening-config %}
## Настройка утверждений маркера

Вы можете повысить безопасность конфигурации OIDC, настроив утверждения, входящие в состав JWT. Эти настройки позволяют определить более детализированные условия доверия для облачных ролей при предоставлении рабочим процессам доступа к ресурсам, размещенным в облаке:

{% ifversion ghec %} — для дополнительного уровня безопасности можно добавить `issuer` URL-адрес с помощью корпоративного slug. Это позволяет задать условия для утверждения издателя (`iss`), настроив его так, чтобы оно принимало только маркеры JWT из уникального `issuer` URL-адреса, который должен включать ваш корпоративный slug.{ % endif %}
- Вы можете стандартизировать конфигурацию OIDC, задав условия для утверждения темы (`sub`), которые требуют, чтобы маркеры JWT были получены из определенного репозитория, повторного рабочего процесса или другого источника.
- Вы можете определить детализированные политики OIDC с помощью дополнительных утверждений токена OIDC, таких как `repository_id` и `repository_visibility`. Дополнительные сведения см. в разделе [Общие сведения о токене OIDC](/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token).

Чтобы настроить эти форматы утверждений, администраторы организации и репозитория могут использовать конечные точки REST API, описанные в следующих разделах.

{% ifversion ghec %}

### Переключение на уникальный URL-адрес маркера

По умолчанию JWT выдается поставщиком OIDC {% data variables.product.prodname_dotcom %}по адресу `https://token.actions.githubusercontent.com`. Этот путь представляется поставщику облачных служб с использованием `iss` значения в JWT.

Администраторы предприятия могут повысить безопасность своей конфигурации OIDC, настроив корпоративный для получения маркеров с уникального URL-адреса по адресу `https://token.actions.githubusercontent.com/<enterpriseSlug>`. Замените `<enterpriseSlug>` значением slug вашего предприятия. 

Такая конфигурация означает, что ваше предприятие получит маркер OIDC по уникальному URL-адресу, а затем вы можете настроить поставщика облачных служб так, чтобы он принимал только маркеры из этого URL-адреса. Это гарантирует, что только репозитории предприятия могут получить доступ к облачным ресурсам с помощью OIDC.

Чтобы активировать этот параметр для предприятия, администратор предприятия должен использовать конечную точку `/enterprises/{enterprise}/actions/oidc/customization/issuer` и указать `"include_enterprise_slug": true` в тексте запроса. Дополнительные сведения см. в разделе [Настройка настраиваемой политики издателя {% data variables.product.prodname_actions %} OIDC для предприятия](/rest/actions/oidc#set-the-github-actions-oidc-custom-issuer-policy-for-an-enterprise).

После применения этого параметра JWT будет содержать обновленное `iss` значение. В следующем примере ключ использует `octocat-inc` в `iss` качестве значения`enterpriseSlug`:

```json
{
  "jti": "6f4762ed-0758-4ccb-808d-ee3af5d723a8"
  "sub": "repo:octocat-inc/private-server:ref:refs/heads/main"
  "aud": "http://octocat-inc.example/octocat-inc"
  "enterprise": "octocat-inc"
  "iss": "https://token.actions.githubusercontent.com/octocat-inc",
  "bf": 1755350653,
  "exp": 1755351553,
  "iat": 1755351253
}
```

{% endif %}

### Настройка утверждений субъекта для организации или репозитория

Чтобы повысить безопасность, соответствие требованиям и стандартизацию, можно настроить стандартные утверждения в соответствии с требуемыми условиями доступа. Если поставщик облачных служб поддерживает условия для утверждений субъекта, можно создать условие, которое проверяет, соответствует ли `sub` значение пути повторно используемого рабочего процесса, например `"job_workflow_ref: "octo-org/octo-automation/.github/workflows/oidc.yml@refs/heads/main""`. Точный формат зависит от конфигурации OIDC поставщика облачных служб. Чтобы настроить условие сопоставления в {% data variables.product.prodname_dotcom %}, можно использовать REST API, чтобы требовать, `sub` чтобы утверждение всегда включало определенное пользовательское утверждение, например `job_workflow_ref`. Для применения шаблона настройки для утверждения субъекта [OIDC можно использовать REST API OIDC](/rest/actions/oidc) . Например, можно требовать, чтобы `sub` утверждение в токене OIDC всегда включало определенное пользовательское утверждение, например `job_workflow_ref`.

{% note %}

**Примечание**. Применение шаблона организации не повлияет на рабочие процессы в существующих репозиториях, которые уже используют OIDC. Для существующих репозиториев, а также любых новых репозиториев, созданных после применения шаблона, владелец репозитория должен будет согласиться на получение этой конфигурации или применить другую конфигурацию, специфичную для репозитория. Дополнительные сведения см. в разделе [Настройка шаблона настройки для утверждения субъекта OIDC для репозитория](/rest/actions/oidc#set-the-customization-template-for-an-oidc-subject-claim-for-a-repository).

{% endnote %}

Настройка утверждений приводит к новому формату для всего `sub` утверждения, который заменяет предопределенный `sub` формат по умолчанию в маркере, описанном в разделе "[Примеры утверждений субъекта](/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#example-subject-claims)".

В следующих примерах шаблонов демонстрируются различные способы настройки утверждения субъекта. Чтобы настроить эти параметры в {% data variables.product.prodname_dotcom %}, администраторы используют REST API для указания списка утверждений, которые должны быть включены в утверждение субъекта (`sub`). 

{% data reusables.actions.use-request-body-api %}

Чтобы настроить утверждения субъекта, необходимо сначала создать условие соответствия в конфигурации OIDC поставщика облачных служб, прежде чем настраивать конфигурацию с помощью REST API. После завершения настройки при каждом запуске нового задания маркер OIDC, созданный во время этого задания, будет следовать новому шаблону настройки. Если условие соответствия не существует в конфигурации OIDC поставщика облачных служб перед выполнением задания, созданный маркер может быть не принят поставщиком облачных служб, так как условия облака могут не быть синхронизированы.

#### Пример. Разрешение репозитория на основе видимости и владельца

Этот пример шаблона позволяет утверждению `sub` иметь новый формат с помощью `repository_owner` и `repository_visibility`:

```json
{
   "include_claim_keys": [
       "repository_owner",
       "repository_visibility"
   ]
}
```

В конфигурации OIDC поставщика облачных служб настройте `sub` условие, требующее, чтобы утверждения включали определенные значения для `repository_owner` и `repository_visibility`. Например: `"repository_owner: "monalisa":repository_visibility:private"`. Этот подход позволяет ограничить доступ к облачным роли только частным репозиториям в организации или на предприятии.

#### Пример: разрешение доступа ко всем репозиториям с определенным владельцем

Этот пример шаблона позволяет утверждению `sub` иметь новый формат только со значением `repository_owner`. 

{% data reusables.actions.use-request-body-api %}

```json
{
   "include_claim_keys": [
       "repository_owner"
   ]
}

```

В конфигурации OIDC поставщика облачных служб настройте `sub` условие, требующее, чтобы утверждения включали определенное значение для `repository_owner`. Например: `"repository_owner: "monalisa""`

#### Пример. Требуется повторно используемый рабочий процесс

Этот пример шаблона позволяет утверждению `sub` иметь новый формат, содержащий значение `job_workflow_ref` утверждения. Это позволяет предприятиям использовать [повторно используемые рабочие процессы](/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#example-subject-claims) для обеспечения согласованного развертывания в своих организациях и репозиториях.

{% data reusables.actions.use-request-body-api %}

```json
  {
     "include_claim_keys": [
         "job_workflow_ref"
     ]
  }
```

В конфигурации OIDC поставщика облачных служб настройте `sub` условие, требующее, чтобы утверждения включали определенное значение для `job_workflow_ref`. Например: `"job_workflow_ref: "octo-org/octo-automation/.github/workflows/oidc.yml@refs/heads/main""`.

#### Пример. Требование повторного рабочего процесса и других утверждений

В следующем примере шаблона комбинируются требования конкретного повторно используемых рабочих процессов с дополнительными утверждениями.

{% data reusables.actions.use-request-body-api %}

В этом примере также показано, как использовать `"context"` для определения условий. Это часть, которая следует за репозиторием в [формате по умолчанию`sub`](/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#example-subject-claims). Например, если задание ссылается на среду, контекст содержит: `environment:<environmentName>`.

```json
{
   "include_claim_keys": [
       "repo",
       "context",
       "job_workflow_ref"
   ]
}
```

В конфигурации OIDC поставщика облачных служб настройте `sub` условие, которое требует, чтобы утверждения включали определенные значения для `repo`, `context`и `job_workflow_ref`.

Для этого шаблона настройки требуется, чтобы в параметре `sub` использовался следующий формат: `repo:<orgName/repoName>:environment:<environmentName>:job_workflow_ref:<reusableWorkflowPath>`. Например: `"sub": "repo:octo-org/octo-repo:environment:prod:job_workflow_ref:octo-org/octo-automation/.github/workflows/oidc.yml@refs/heads/main"`

#### Пример. Предоставление доступа к определенному репозиторию

Этот пример шаблона позволяет предоставить облачный доступ ко всем рабочим процессам в определенном репозитории во всех ветвях, тегах и средах. Чтобы повысить безопасность, объедините этот шаблон с настраиваемым URL-адресом издателя, описанным в разделе [Настройка URL-адреса маркера для предприятия](/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#customizing-the-token-url-for-an-enterprise). 

{% data reusables.actions.use-request-body-api %}

```json
{
   "include_claim_keys": [
       "repo"
   ]
}
```

В конфигурации OIDC поставщика облачных служб настройте `sub` условие, чтобы требовать `repo` утверждение, соответствующее требуемому значению.

#### Пример. Использование системных идентификаторов GUID

Этот пример шаблона позволяет прогнозировать утверждения OIDC с созданными системой идентификаторами GUID, которые не меняются между переименованиями сущностей (например, переименованием репозитория). 

{% data reusables.actions.use-request-body-api %}

```json
  {
     "include_claim_keys": [
         "repository_id"
     ]
  }
```

В конфигурации OIDC поставщика облачных служб настройте `sub` условие, чтобы требовать `repository_id` утверждение, соответствующее требуемому значению.

или:

```json
{
   "include_claim_keys": [
       "repository_owner_id"
   ]
}
```

В конфигурации OIDC поставщика облачных служб настройте `sub` условие, чтобы требовать `repository_owner_id` утверждение, соответствующее требуемому значению.

#### Сброс настроек

В этом примере шаблона утверждения субъекта сбрасываются в формат по умолчанию. Этот шаблон фактически откловает любую политику настройки на уровне организации.

{% data reusables.actions.use-request-body-api %}

```json
{
   "include_claim_keys": [
       "repo",
       "context"
   ]
}
```

В конфигурации OIDC поставщика облачных служб настройте `sub` условие, требующее, чтобы утверждения включали определенные значения для `repo` и `context`.

#### Использование утверждений субъекта по умолчанию

Для репозиториев, которые могут получать политику утверждения субъекта от своей организации, владелец репозитория может позже отказаться от него и вместо этого использовать формат утверждения по умолчанию `sub` . Это означает, что репозиторий не будет использовать настраиваемый шаблон организации. 

Чтобы настроить репозиторий для использования формата утверждений по умолчанию `sub` , администратор репозитория должен использовать конечную точку REST API в разделе "[Настройка шаблона настройки для утверждения субъекта OIDC для репозитория](/rest/actions/oidc#set-the-customization-template-for-an-oidc-subject-claim-for-a-repository)" со следующим текстом запроса:

```json
{
   "use_default": true
}
```

#### Пример. Настройка репозитория для использования шаблона организации

Администратор репозитория может настроить свой репозиторий для использования шаблона, созданного администратором организации.

Чтобы настроить репозиторий для использования шаблона организации, администратор репозитория должен использовать конечную точку REST API в разделе "[Настройка шаблона настройки для утверждения субъекта OIDC для репозитория](/rest/actions/oidc#set-the-customization-template-for-an-oidc-subject-claim-for-a-repository)" со следующим текстом запроса:

```json
{
   "use_default": false
}
```

{% endif %}

## Изменение рабочих процессов для использования OIDC

Теперь можно изменить рабочие процессы YAML так, чтобы вместо секретов использовались маркеры доступа OIDC. Популярные поставщики облачных служб опубликовали официальные действия входа, что упрощает начало работы с OIDC. Дополнительные сведения об изменении рабочих процессов см. в руководстве для конкретного облака по ссылке ниже в разделе [Включение OpenID Connect для поставщика облачных служб](#enabling-openid-connect-for-your-cloud-provider).


## Включение OpenID Connect для поставщика облачных служб

Инструкции по включению и настройке OIDC для конкретного поставщика облачных служб см. в одном из следующих руководств:

- [Настройка OpenID Connect в Amazon Web Services](/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)
- [Настройка OpenID Connect в Azure](/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-azure)
- [Настройка OpenID Connect в Google Cloud Platform](/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-google-cloud-platform)
- [Настройка OpenID Connect в HashiCorp Vault](/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-hashicorp-vault)

Инструкции по включению и настройке OIDC для другого поставщика облачных служб см. в следующем руководстве:

- [Настройка OpenID Connect в поставщиках облачных служб](/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-cloud-providers)
