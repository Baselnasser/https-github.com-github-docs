---
title: Обработка изменений плана
intro: 'Повышение или понижение уровня приложения {% data variables.product.prodname_marketplace %} запускает веб-перехватчик [`marketplace_purchase` события](/marketplace/integrating-with-the-github-marketplace-api/github-marketplace-webhook-events/) с действием `changed`, которое запускает поток повышение или понижение уровня.'
redirect_from:
  - /apps/marketplace/administering-listing-plans-and-user-accounts/upgrading-or-downgrading-plans
  - /apps/marketplace/integrating-with-the-github-marketplace-api/upgrading-and-downgrading-plans
  - /marketplace/integrating-with-the-github-marketplace-api/upgrading-and-downgrading-plans
  - /developers/github-marketplace/handling-plan-changes
versions:
  fpt: '*'
  ghec: '*'
topics:
  - Marketplace
ms.openlocfilehash: fd5cc838c01130ab9e8a1f7c040b254655cbaef0
ms.sourcegitcommit: 47bd0e48c7dba1dde49baff60bc1eddc91ab10c5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/05/2022
ms.locfileid: '145135863'
---
Дополнительные сведения о повышении и понижении уровня в контексте выставления счетов см. в разделе [Интеграция с API {% data variables.product.prodname_marketplace %}](/marketplace/integrating-with-the-github-marketplace-api/).

## Шаг 1. Событие изменения плана ценообразования

GitHub отправляет веб-перехватчик `marketplace_purchase` с действием `changed` в приложение, когда клиент вносит такие изменения в свой заказ {% data variables.product.prodname_marketplace %}:
* Повышение уровня до более дорогого плана или понижения до более дешевого тарифного плана.
* Добавляет или удаляет рабочие места из существующего плана.
* Вносит изменения в цикл выставления счетов.

GitHub отправит веб-перехватчик, когда изменение вступит в силу. Например, когда клиент понижает уровень тарифного плана, GitHub отправляет веб-перехватчик в конце цикла выставления счетов клиента. GitHub отправляет веб-перехватчик в приложение сразу, если клиент повышает уровень плана, чтобы сразу разрешить ему доступ к новой службе. Если клиент переходит с месячного на годовой цикл выставления счетов, это считается повышением уровня. Дополнительные сведения о действиях, которые считаются повышением или понижением уровня, см. в разделе [Выставление счетов клиентам в {% data variables.product.prodname_marketplace %}](/marketplace/selling-your-app/billing-customers-in-github-marketplace/).

Ознакомьтесь с `effective_date`, `marketplace_purchase` и `previous_marketplace_purchase` в веб-перехватчике `marketplace_purchase`, чтобы обновить дату начала действия плана и внести изменения в цикл выставления счетов и тарифный план клиента. Пример полезных данных `marketplace_purchase` см. в разделе [{% data variables.product.prodname_marketplace %}](/marketplace/integrating-with-the-github-marketplace-api/github-marketplace-webhook-events/).

Если для вашего приложения предлагаются бесплатные пробные версии, вы получите веб-перехватчик `marketplace_purchase` с помощью действия `changed` после истечения срока действия бесплатной пробной версии. Если срок действия бесплатной пробной версии клиента истекает, переведите клиент с бесплатной пробной версии на платный план.

## Шаг 2. Обновление учетных записей клиентов

Вам потребуется обновить сведения об учетной записи клиента, чтобы отразить цикл выставления счетов и изменения в плане ценообразования, внесенные клиентом в свой заказ {% data variables.product.prodname_marketplace %}. Отображение повышения уровня для тарифного плана `seat_count` (для тарифных планов с оплатой по числу единиц) и цикла выставления счетов на веб-сайте приложения Marketplace или в пользовательском интерфейсе приложения при получении веб-перехватчика действия `changed`.

Когда клиент понижает уровень тарифного плана, рекомендуется проверить, не превысил ли клиент лимиты для плана, и взаимодействовать с клиентом напрямую в пользовательском интерфейсе или связаться с ним по телефону или по электронной почте.

Чтобы мотивировать пользователей повысить уровень, вы можете настроить отображение URL-адреса обновления в пользовательском интерфейсе приложения. Дополнительные сведения см. в разделе [Сведения об URL-адресах обновления](#about-upgrade-urls).

{% note %}

**Примечание.** Мы рекомендуем регулярно выполнять синхронизацию с помощью `GET /marketplace_listing/plans/:id/accounts`, чтобы убедиться, что приложение использует правильный план, информацию о цикле выставления счетов и количество единиц (для тарифных планов с оплатой по числу единиц) для каждой учетной записи.

{% endnote %}

## Ошибка платежа при повышении уровня

{% data reusables.marketplace.marketplace-failed-purchase-event %}

## Сведения об URL-адресах обновления

Вы можете перенаправить пользователей из пользовательского интерфейса приложения, чтобы повысить уровень в GitHub с помощью URL-адреса обновления:

```text
https://www.github.com/marketplace/<LISTING_NAME>/upgrade/<LISTING_PLAN_NUMBER>/<CUSTOMER_ACCOUNT_ID>
```

Например, если вы заметили, что клиент использует тарифный план, рассчитанный на 5 пользователей, и ему требуется перейти на план на 10 пользователей, можно отобразить в пользовательском интерфейсе приложения кнопку с текстом "Действия для повышения уровня" или баннер со ссылкой на URL-адрес обновления. URL-адрес обновления перенаправляет клиента на страницу, где можно подтвердить повышение уровня тарифного плана.

Используйте `LISTING_PLAN_NUMBER` для тарифного плана, который клиент хочет приобрести. При создании новых тарифных планов они получают `LISTING_PLAN_NUMBER`, который является уникальным для каждого плана в листинге, а также `LISTING_PLAN_ID`, который также является уникальным для каждого плана в {% data variables.product.prodname_marketplace %}. Эти цифры можно найти при [перечислении планов](/rest/reference/apps#list-plans), которые идентифицируют тарифные планы в вашем листинге. Используйте конечную точку `LISTING_PLAN_ID` и [Список учетных записей для плана](/rest/reference/apps#list-accounts-for-a-plan), чтобы получить `CUSTOMER_ACCOUNT_ID`.


{% note %}

**Примечание.** Если ваш клиент повышает уровень с учетом дополнительных единиц (например, рабочих мест), вы по-прежнему можете перевести его на страницу, где он может приобрести нужный план, но мы не поддерживаем параметры `unit_count` в настоящее время.

{% endnote %}
