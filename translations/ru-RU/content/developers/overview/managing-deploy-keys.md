---
title: Управление ключами развертывания
intro: 'Изучите несколько способов управлять ключами SSH на серверах при автоматизации сценариев развертывания и узнайте, какой из них вам лучше подходит.'
redirect_from:
  - /guides/managing-deploy-keys
  - /v3/guides/managing-deploy-keys
  - /deploy-keys
  - /articles/managing-deploy-keys
  - /multiple-keys
versions:
  fpt: '*'
  ghes: '*'
  ghae: '*'
  ghec: '*'
topics:
  - API
ms.openlocfilehash: d038e6d56395a5a3d414170e431487fc0b80b426
ms.sourcegitcommit: d697e0ea10dc076fd62ce73c28a2b59771174ce8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/20/2022
ms.locfileid: '148094188'
---
Ключами SSH можно управлять на серверах при автоматизации сценариев развертывания с помощью перенаправления агента SSH, HTTPS с токенами OAuth, развертывания ключей или пользователей компьютера.

## Перенаправление агента SSH

Во многих случаях, особенно, в начале проекта, перенаправление агента SSH является самым быстрым и простым способом использования. При перенаправлении агента используются те же ключи SSH, что и на локальном компьютере разработки.

#### Плюсы

* Создавать или отслеживать новые ключи не нужно.
* Управление ключами отсутствует; пользователи имеют те же разрешения на сервере, что и на локальном компьютере.
* Ключи не хранятся на сервере, поэтому, если сервер скомпрометирован, вам не нужно искать и удалять скомпрометированные ключи.

#### Минусы

* Пользователи **должны выполнять** развертывание по протоколу SSH; Невозможно использовать автоматизированные процессы развертывания.
* Перенаправление агента SSH может быть сложной задачей для пользователей Windows.

#### Настройка

1. Включите перенаправление агента локально. Дополнительные сведения см. [в нашем руководстве по перенаправлению агента SSH][ssh-agent-forwarding].
2. Задайте сценарии развертывания для перенаправления агента. Например, в сценарии bash включение перенаправления агента будет выглядеть примерно так: `ssh -A serverA 'bash -s' < deploy.sh`

## Клонирование HTTPS с помощью токенов OAuth

Если не требуется использовать ключи SSH, можно использовать HTTPS с токенами OAuth.

#### Плюсы

* Любой пользователь с доступом к серверу может развернуть репозиторий.
* Пользователям не нужно изменять локальные параметры SSH.
* Несколько токенов (по одному для каждого пользователя) не требуется; достаточно одного токена на сервер.
* Токен можно отозвать в любое время, превратив его в одноразовый пароль.
{% ifversion ghes %}
* Новые токены можно легко создать с помощью сценария [API OAuth](/rest/reference/oauth-authorizations#create-a-new-authorization).
{% endif %}

#### Минусы

* Необходимо убедиться, что токен настроен с правильными областями доступа.
* По сути токены являются паролями и должны защищаться так же.

#### Настройка

Ознакомьтесь с [нашим руководством по созданию {% данных variables.product.pat_generic %}](/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token).

## Ключи развертывания

{% data reusables.repositories.deploy-keys %}

{% data reusables.repositories.deploy-keys-write-access %}

#### Плюсы

* Любой пользователь с доступом к репозиторию и серверу может развернуть проект.
* Пользователям не нужно изменять локальные параметры SSH.
* Ключи развертывания по умолчанию доступны только для чтения, но вы можете предоставить им доступ для записи при добавлении их в репозиторий.

#### Минусы

* Ключи развертывания предоставляет доступ только к одному репозиторию. Более сложные проекты могут содержать множество репозиториев для извлечения на тот же сервер.
* Ключи развертывания, как правило, не защищены парольной фразой, что упрощает доступ к ключу, если сервер скомпрометирован.

#### Настройка

1. [Запустите `ssh-keygen`процедуру][generating-ssh-keys] на сервере и запомните путь сохранения созданной пары ключей открытого и закрытого ключей RSA.
{% данных reusables.profile.navigating-to-profile %} 

   ![Переход к профилю](/assets/images/profile-page.png)
1. На странице профиля нажмите кнопку **Репозитории**, а затем имя репозитория. ![Ссылка на репозитории](/assets/images/repos.png)
2. Из своего репозитория нажмите **Параметры**. ![Параметры репозитория](/assets/images/repo-settings.png)
3. На боковой панели нажмите **Ключи развертывания**, а затем нажмите кнопку **Добавить ключ развертывания**. ![Ссылка «Добавить ключи развертывания»](/assets/images/add-deploy-key.png)
4. Укажите название, вставьте в свой открытый ключ.  ![Страница ключей развертывания](/assets/images/deploy-key.png)
5. Выберите **Разрешить доступ на запись**, если этот ключ должен иметь доступ на запись в репозитории. Ключ развертывания с доступом на запись позволяет отправить развертывание в репозиторий.
6. Нажмите **Добавить ключ**.

#### Использование нескольких репозиториев на одном сервере

При использовании нескольких репозиториев на одном сервере необходимо создать выделенную пару ключей для каждого из них. Невозможно повторно использовать ключ развертывания для нескольких репозиториев.

В файле конфигурации сервера SSH (обычно `~/.ssh/config`) добавьте запись псевдонима для каждого репозитория. Пример:

```bash
Host {% ifversion fpt or ghec %}github.com{% else %}my-GHE-hostname.com{% endif %}-repo-0
        Hostname {% ifversion fpt or ghec %}github.com{% else %}my-GHE-hostname.com{% endif %}
        IdentityFile=/home/user/.ssh/repo-0_deploy_key

Host {% ifversion fpt or ghec %}github.com{% else %}my-GHE-hostname.com{% endif %}-repo-1
        Hostname {% ifversion fpt or ghec %}github.com{% else %}my-GHE-hostname.com{% endif %}
        IdentityFile=/home/user/.ssh/repo-1_deploy_key
```

* `Host {% ifversion fpt or ghec %}github.com{% else %}my-GHE-hostname.com{% endif %}-repo-0` — псевдоним репозитория.
* `Hostname {% ifversion fpt or ghec %}github.com{% else %}my-GHE-hostname.com{% endif %}` — настраивает имя узла для использования с псевдонимом.
* `IdentityFile=/home/user/.ssh/repo-0_deploy_key` — назначает псевдониму закрытый ключ.

Затем можно использовать псевдоним имени узла для взаимодействия с репозиторием с помощью SSH, который будет использовать уникальный ключ развертывания, назначенный данному псевдониму. Пример:

```bash
$ git clone git@{% ifversion fpt or ghec %}github.com{% else %}my-GHE-hostname.com{% endif %}-repo-1:OWNER/repo-1.git
```

## Маркеры "сервер-сервер"

Если серверу требуется доступ к репозиториям в одной или нескольких организациях, можно использовать приложение GitHub для определения необходимого доступа, а затем в этом приложении GitHub создать _строго ограниченные_ маркеры _«сервера-сервер»_ . Маркеры «сервер-сервер» могут ограничиваться одним или несколькими репозиториями, и иметь точные разрешения. Например, можно создать маркер с доступом только для чтения к содержимому репозитория.

Так как приложения GitHub являются субъектом первого класса для {% data variables.product.product_name %}, маркеры «сервер-сервер» отделяются от любого пользователя GitHub, что делает их сопоставимыми с "маркерами службы". Кроме того, маркеры «сервер-сервер» имеют выделенные ограничения скорости, которые масштабируются по размеру организаций, в которых маркеры действуют. Дополнительные сведения см. в разделе [Ограничения скорости для {% data variables.product.prodname_github_apps %}](/developers/apps/rate-limits-for-github-apps).

#### Плюсы

- Строго ограниченные маркеры с четко определенными наборами разрешений и сроком действия (1 час или меньше, если отозван вручную с помощью API).
- Выделенные ограничения скорости растут вместе с вашей организацией.
- Отсоединено от удостоверений пользователей GitHub, поэтому лицензированные места не используются.
- Пароль никогда не предоставлялся, поэтому невозможно выполнить прямой вход в систему.

#### Минусы

- Для создания приложения GitHub требуется дополнительная настройка.
- Срок действия маркеров «сервер-сервер» истекает через 1 час, поэтому их необходимо создавать повторно, обычно, по запросу с помощью кода.

#### Настройка

1. Определите, каким должно быть приложение GitHub: общедоступным или частным. Если ваше приложение GitHub будет работать в вашей организации только с репозиториями, вероятно, вы захотите, чтобы оно было частным.
1. Определите разрешения, требуемые для приложения GitHub, например, доступ только для чтения к содержимому репозитория.
1. Создайте приложение GitHub с помощью страницы параметров организации. Дополнительные сведения см. в разделе [Создание приложения GitHub](/developers/apps/creating-a-github-app).
1. Запишите `id` своего приложения GitHub.
1. Создайте и скачайте закрытый ключ приложения GitHub и сохраните его в надежном месте. Дополнительные сведения см. в статье [Создание закрытого ключа](/developers/apps/authenticating-with-github-apps#generating-a-private-key).
1. Установите приложение GitHub в репозиториях, в которых оно должно работать. При необходимости можно установить приложение GitHub на все репозитории в вашей организации.
1. Определите `installation_id`, который представляет собой подключение между приложением GitHub и репозиториями организации, к которым можно получить доступ.  Каждая пара «приложение GitHub и организация» имеет не более одного `installation_id`. Можно определить этот `installation_id` с помощью [получения установки организации для приложения, прошедшего проверку подлинности](/rest/reference/apps#get-an-organization-installation-for-the-authenticated-app). Для этого требуется проверка подлинности в приложении GitHub с помощью JWT. Дополнительные сведения см. в статье [Проверка подлинности в приложении GitHub](/developers/apps/authenticating-with-github-apps#authenticating-as-a-github-app).
1. Создайте маркер «сервер-сервер», используя соответствующую конечную точку REST API, [Создайте маркер доступа установки для приложения](/rest/reference/apps#create-an-installation-access-token-for-an-app). Для этого требуется проверка подлинности в приложении GitHub с помощью JWT. Дополнительные сведения см. в статье [Проверка подлинности в приложении GitHub](/developers/apps/authenticating-with-github-apps#authenticating-as-a-github-app) и [Проверка подлинности при установке](/developers/apps/authenticating-with-github-apps#authenticating-as-an-installation).
1. Используйте этот маркер «сервер-сервер» для взаимодействия с репозиториями с помощью REST, API GraphQL или клиента Git.

## Пользователи компьютеров

Если вашему серверу требуется доступ к нескольким репозиториям, можно создать учетную запись для {% ifversion ghae %}{% данных variables.product.product_name %}{% else %}{% данных variables.location.product_location %}{% endif %} и присоединить ключ SSH, который будет использоваться исключительно для автоматизации. Так как эта учетная запись для {% ifversion ghae %}{% данных variables.product.product_name %}{% else %}{% данных variables.location.product_location %}{% endif %} не будет использоваться человеком, он называется _пользователем компьютера_. Вы можете добавить пользователя компьютера в качестве [участника совместной работы][collaborator] в личном репозитории (предоставление права на чтение и запись), в качестве [внешнего участника совместной работы][outside-collaborator] в репозитории организации (предоставление права на чтение, записи или администратора) или для [команды][team] с доступом к репозиториям, которые необходимо автоматизировать (предоставление прав команде).

{% ifversion fpt or ghec %}

{% tip %}

**Совет.** Наши [условия предоставления услуг][tos]:

> *Учетные записи, зарегистрированные "ботами" или другими автоматизированными методами, запрещены.*

Это означает, что невозможно автоматизировать создание учетных записей. Но если требуется создать одного пользователя компьютера для автоматизации таких задач, как сценарии развертывания в проекте или организации, это отлично.

{% endtip %}

{% endif %}

#### Плюсы

* Любой пользователь с доступом к репозиторию и серверу может развернуть проект.
* Пользователям не нужно изменять их локальные параметры SSH.
* Несколько ключей не требуются; одного на сервер достаточно.

#### Минусы

* Ограничить доступ пользователей компьютеров правами только для чтения могут только организации. Личные репозитории всегда предоставляют участникам совместной работы доступ на чтение и запись.
* Ключи пользователя компьютера, такие как ключи развертывания, как правило, не защищены парольной фразой.

#### Настройка

1. [Запустите `ssh-keygen`процедуру][generating-ssh-keys] на сервере и подключите открытый ключ к учетной записи пользователя компьютера.
2. Предоставьте учетной записи пользователя компьютера доступ к репозиториям, которые требуется автоматизировать. Это можно сделать, добавив учетную запись в качестве [участника совместной работы][collaborator], в качестве [внешнего участника совместной работы][outside-collaborator] или для [команды][team] в организации.

[ssh-agent-forwarding]: /guides/using-ssh-agent-forwarding/
[generating-ssh-keys]: /articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/#generating-a-new-ssh-key
[tos]: /free-pro-team@latest/github/site-policy/github-terms-of-service/
[git-automation]: /articles/git-automation-with-oauth-tokens
[collaborator]: /articles/inviting-collaborators-to-a-personal-repository
[outside-collaborator]: /articles/adding-outside-collaborators-to-repositories-in-your-organization
[team]: /articles/adding-organization-members-to-a-team

## Дополнительные материалы
- [Настройка уведомлений](/account-and-profile/managing-subscriptions-and-notifications-on-github/setting-up-notifications/configuring-notifications#organization-alerts-notification-options)
