---
title: Использование API GitHub в приложении
intro: 'Узнайте, как настроить приложение для прослушивания событий и использовать библиотеку Octokit для выполнения операций REST API.'
redirect_from:
  - /apps/building-your-first-github-app
  - /apps/quickstart-guides/using-the-github-api-in-your-app
  - /developers/apps/using-the-github-api-in-your-app
versions:
  fpt: '*'
  ghes: '*'
  ghae: '*'
  ghec: '*'
topics:
  - GitHub Apps
shortTitle: Build an app with the REST API
ms.openlocfilehash: 66f5952c05e20a1eb300d4ecce94e38761edaa0e
ms.sourcegitcommit: 58f69d95fcc8a2fd1c2fb736a0ad8e7ee1858be4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/07/2022
ms.locfileid: '148012650'
---
## Введение

Это руководство поможет вам создать приложение GitHub и запустить его на сервере. Приложение, которое вы создаете, добавит метку ко всем новым проблемам, открытым в репозитории, где оно установлено.

Этот проект позволит вам выполнить следующие действия:

* программирование приложения для ожидания передачи данных для событий;
* использование библиотеки Octokit.rb для выполнения операций REST API.

{% data reusables.apps.app-ruby-guides %}

После выполнения этих шагов вы будете готовы к разработке других видов интеграции с помощью полного набора API-интерфейсов GitHub. {% ifversion fpt or ghec %}Вы можете получить для изменения рабочие примеры приложений в [GitHub Marketplace](https://github.com/marketplace) и [Работает с приложениями GitHub](https://github.com/works-with).{% endif %}

## Предварительные требования

Могут быть полезны базовые знания в следующих областях:

* [Приложения GitHub](/apps/about-apps)
* [Объекты Webhook](/webhooks)
* [язык Ruby](https://www.ruby-lang.org/en/);
* [REST API](/rest);
* [Sinatra](http://sinatrarb.com/).

Но вы можете работать, имея любой уровень опыта. Мы будем ссылаться на необходимую информацию на этом пути!

Перед началом работы сделайте следующее:

1. Клонируйте репозиторий для [использования API GitHub в приложении](https://github.com/github-developer/using-the-github-api-in-your-app).
  ```shell
    $ git clone https://github.com/github-developer/using-the-github-api-in-your-app.git
  ```

  В каталоге вы найдете файл `template_server.rb` с кодом шаблона, который будет использоваться в этом кратком руководстве, и файл `server.rb` с готовым кодом проекта.

1. Выполните действия, описанные в кратком руководстве [Настройка среды разработки](/apps/quickstart-guides/setting-up-your-development-environment/), чтобы настроить и запустить сервер приложений `template_server.rb`. Если вы ранее выполнили инструкции из краткого руководства по приложению GitHub, отличного от руководства [Настройка среды разработки](/apps/quickstart-guides/setting-up-your-development-environment/), зарегистрируйте _новое_ приложение GitHub и запустите новый канал Smee, который будет использоваться с этим кратким руководством.

  В этом кратком руководстве содержится тот же код `template_server.rb`, что и в кратком руководстве [Настройка среды разработки](/apps/quickstart-guides/setting-up-your-development-environment/). **Примечание.** Следуя инструкциям из краткого руководства [Настройка среды разработки](/apps/quickstart-guides/setting-up-your-development-environment/), обязательно используйте файлы проекта, включенные в репозиторий для [применения API GitHub в приложении](https://github.com/github-developer/using-the-github-api-in-your-app).

  Если у вас возникли проблемы с настройкой шаблона приложения GitHub, ознакомьтесь с разделом [Устранение неполадок](/apps/quickstart-guides/setting-up-your-development-environment/#troubleshooting).

## Сборка приложения

Теперь, когда вы знакомы с кодом `template_server.rb`, вы можете создать код, который автоматически добавляет метку `needs-response` ко всем проблемам, открытым в репозитории, где установлено приложение.

Файл `template_server.rb` содержит код шаблона приложения, который еще не был настроен. В этом файле вы увидите код заполнителя для обработки событий веб-перехватчика и другой код для инициализации клиента Octokit.rb.

{% note %}

**Примечание.** `template_server.rb` содержит множество комментариев к коду, которые дополняют это руководство и объясняют дополнительные технические сведения. Чтобы получить общие сведения о работе кода, вы можете ознакомиться с комментариями в этом файле, прежде чем продолжить работу с данным разделом.

Окончательный настроенный код, который вы создадите в конце этого руководства, приведен в [`server.rb`](https://github.com/github-developer/using-the-github-api-in-your-app/blob/master/server.rb). Однако попробуйте дойти до конца, чтобы ознакомиться с ним!

{% endnote %}

Ниже приведены шаги, которые необходимо выполнить для создания первого приложения GitHub.

1. [Обновление разрешений приложения](#step-1-update-app-permissions)
2. [Добавление средств обработки событий](#step-2-add-event-handling)
3. [Создание новой метки](#step-3-create-a-new-label)
4. [Добавление средств обработки меток](#step-4-add-label-handling)

## Шаг 1. Обновление разрешений приложения

При [первой регистрации приложения](/apps/quickstart-guides/setting-up-your-development-environment/#step-2-register-a-new-github-app) вы приняли разрешения по умолчанию, а это означает, что у приложения нет доступа к большинству ресурсов. В этом примере приложению потребуется разрешение на чтение проблем и запись меток.

Чтобы обновить разрешения приложения:

1. Выберите приложение на [странице параметров приложения](https://github.com/settings/apps) и щелкните **Разрешения и веб-перехватчики** на боковой панели.
1. В разделе "Разрешения" откройте пункт "Проблемы" и выберите **Чтение и запись** в раскрывающемся списке "Доступ" рядом с ним. В описании говорится, что этот параметр предоставляет разрешения для доступа как к проблемам, так и к меткам, а именно это вам и нужно.
1. Чтобы подписаться на событие, выберите **Проблемы** в разделе "Подписка на события".
{% data reusables.apps.accept_new_permissions_steps %}

Отлично! Ваше приложение имеет разрешение на выполнение необходимых задач. Теперь вы можете добавить код для его работы.

## Шаг 2. Добавление средств обработки событий

Первое, что нужно сделать вашему приложению, — ожидать передачи данных для новых открытых проблем. Теперь, когда вы подписались на событие **Issues** (Проблемы), вы начнете получать веб-перехватчик [`issues`](/webhooks/event-payloads/#issues), который активируется при возникновении определенных действий, связанных с проблемами. Этот тип события можно отфильтровать для конкретного действия в коде.

GitHub отправляет полезные данные веб-перехватчика в виде запросов `POST`. Так как вы перенаправили полезные данные веб-перехватчика Smee в `http://localhost/event_handler:3000`, сервер получит полезные данные запроса `POST` для маршрута `post '/event_handler'`.

Пустой маршрут `post '/event_handler'` уже включен в файл `template_server.rb`, который вы скачали в разделе [предварительных требований](#prerequisites). Пустой маршрут выглядит следующим образом:

``` ruby
  post '/event_handler' do

    # # # # # # # # # # # #
    # ADD YOUR CODE HERE  #
    # # # # # # # # # # # #

    200 # success status
  end
```

Используйте этот маршрут для обработки события `issues`, добавив следующий код:

``` ruby
case request.env['HTTP_X_GITHUB_EVENT']
when 'issues'
  if @payload['action'] === 'opened'
    handle_issue_opened_event(@payload)
  end
end
```

Каждое событие, которое отправляет GitHub, включает в себя заголовок запроса с именем `HTTP_X_GITHUB_EVENT`, который указывает тип события в запросе `POST`. Сейчас вас интересуют только типы событий `issues`. Каждое событие имеет дополнительное поле `action`, указывающее тип действия, которое активировало события. Для `issues` поле `action` может быть `assigned`, `unassigned`, `labeled`, `unlabeled`, `opened`, `edited`, `milestoned`, `demilestoned`, `closed` или `reopened`.

Чтобы протестировать обработчик событий, попробуйте добавить временный вспомогательный метод. Обновление выполните позже при работе с разделом [Добавление средств обработки меток](#step-4-add-label-handling). Теперь в раздел кода `helpers do` добавьте следующий код. Новый метод можно поместить выше или ниже любого другого вспомогательного метода. Порядок не имеет значения.

``` ruby
def handle_issue_opened_event(payload)
  logger.debug 'An issue was opened!'
end
```

Этот метод получает полезные данные события в формате JSON в качестве аргумента. Это означает, что вы можете анализировать полезные данные в методе и детализировать все необходимые данные. Рекомендуем проверить все полезные данные: попробуйте изменить `logger.debug 'An issue was opened!` на `logger.debug payload`. Отображаемая структура полезных данных должна соответствовать тому, что [показано в `issues`документации по событиям веб-перехватчика](/webhooks/event-payloads/#issues).

Отлично! Пришло время проверить изменения.

{% data reusables.apps.sinatra_restart_instructions %}

В браузере перейдите в репозиторий, в котором установлено приложение. Откройте новую проблему в этом репозитории. В проблеме можете указать все, что хотите. Это просто для тестирования.

Когда вы вернетесь к терминалу, то увидите сообщение в выходных данных: `An issue was opened!` Congrats! (Поздравляем!) Вы добавили обработчик событий в приложение. 💪

## Шаг 3. Создание новой метки

Хорошо, ваше приложение может определить открытие проблем. Теперь вы хотите добавить метку `needs-response` к новой открытой проблеме в репозитории, где установлено приложение.

Перед _добавлением_ метки в любое место необходимо _создать_ пользовательскую метку в репозитории. Это нужно сделать только один раз. Для целей этого руководства создайте метку вручную на сайте GitHub. В репозитории щелкните **Проблемы**, затем **Метки**, а после этого выберите **Новая метка**. Назовите новую метку `needs-response`.

{% tip %}

**Совет.** Было бы замечательно, если бы ваше приложение могло программно создать метку, не правда ли? [Это возможно!](/rest/reference/issues#create-a-label) Попробуйте добавить код самостоятельно после завершения действий, описанных в этом руководстве.

{% endtip %}

Теперь, когда есть метка, вы можете запрограммировать приложение, чтобы использовать REST API для [добавления метки к любой только что открытой проблеме](/rest/reference/issues#add-labels-to-an-issue).

## Шаг 4. Добавление средств обработки меток

Поздравляем! Вы добрались до последнего шага: добавление средства обработки меток в приложение. Для этой задачи необходимо использовать [библиотеку Octokit.rb Ruby](http://octokit.github.io/octokit.rb/).

В документации по Octokit.rb найдите список [методов для метки](http://octokit.github.io/octokit.rb/Octokit/Client/Labels.html). Необходимый метод: [`add_labels_to_an_issue`](http://octokit.github.io/octokit.rb/Octokit/Client/Labels.html#add_labels_to_an_issue-instance_method).

Вернитесь к `template_server.rb` и найдите метод, определенный ранее:

``` ruby
def handle_issue_opened_event(payload)
  logger.debug 'An issue was opened!'
end
```

В документации по [`add_labels_to_an_issue`](http://octokit.github.io/octokit.rb/Octokit/Client/Labels.html#add_labels_to_an_issue-instance_method) указано, что вам потребуется передать три аргумента в этот метод:

* репозиторий (строка в формате `"owner/name"`);
* номер проблемы (целое число);
* метки (массив).

Вы можете анализировать полезные данные, чтобы получить как репозиторий, так и номер проблемы. Так как имя метки всегда будет одинаковым (`needs-response`), его можно передать в виде жестко заданной строки в массиве меток. После объединения этих составляющих обновленный метод может выглядеть следующим образом:

``` ruby
# When an issue is opened, add a label
def handle_issue_opened_event(payload)
  repo = payload['repository']['full_name']
  issue_number = payload['issue']['number']
  @installation_client.add_labels_to_an_issue(repo, issue_number, ['needs-response'])
end
```

Попробуйте открыть новую проблему в тестовом репозитории и посмотрите, что произойдет! Если ничего не произойдет сразу, попробуйте обновить.

В терминале вы не увидите много, _но_ заметите, что пользователь-бот добавил метку к проблеме.

{% note %}

**Примечание.** Когда приложения GitHub выполняют действия через API, например добавление меток, GitHub показывает эти действия как выполняемые учетными записями _ботов_. Дополнительные сведения см. в разделе [Учетные записи компьютера и бота](/apps/differences-between-apps/#machine-vs-bot-accounts).

{% endnote %}

Если удалось, поздравляем! Вы успешно создали рабочее приложение! 🎉

Окончательный код можно увидеть в `server.rb` в [репозитории шаблонов приложений](https://github.com/github-developer/using-the-github-api-in-your-app).

В разделе [Дальнейшие действия](#next-steps) приведены идеи о том, что можно еще сделать.

## Устранение неполадок

Ниже указаны некоторые распространенные проблемы и предлагаемые решения. Если у вас возникли другие проблемы, вы можете обратиться за помощью или советом в {% данных reusables.support.prodname_support_forum_with_url %}.

* **Вопрос.** Что делать, если мой сервер не ожидает передачи данных событий? Клиент Smee работает в окне терминала, и я отправляю события на сайте GitHub.com, открыв новые проблемы, но не вижу выходных данных в окне терминала, где работает сервер.

    **Ответ.** Возможно, у вас неправильно указан домен Smee в параметрах приложения. Перейдите [на страницу параметров приложения](https://github.com/settings/apps) и внимательно проверьте поля в разделе [регистрации нового приложения с помощью GitHub](/apps/quickstart-guides/setting-up-your-development-environment/#step-2-register-a-new-github-app). Убедитесь, что домен в этих полях соответствует домену, который вы использовали в команде `smee -u <unique_channel>` при [запуске нового канала Smee](/apps/quickstart-guides/setting-up-your-development-environment/#step-1-start-a-new-smee-channel).

* **Вопрос.** Что делать, если мое приложение не работает? Я открыл новую проблему, но даже после обновления она без метки.

    **Ответ.** Убедитесь, что все из приведенных ниже условий выполняются:

    * Вы [установили приложение](/apps/quickstart-guides/setting-up-your-development-environment/#step-7-install-the-app-on-your-account) в репозитории, в котором открываете проблему.
    * [Клиент Smee работает](/apps/quickstart-guides/setting-up-your-development-environment/#step-1-start-a-new-smee-channel) в окне терминала.
    * [Веб-сервер работает](/apps/quickstart-guides/setting-up-your-development-environment/#step-6-start-the-server) без ошибок в другом окне терминала.
    * Приложение имеет [разрешения на чтение и запись для проблем и подписку на события проблем](/apps/quickstart-guides/setting-up-your-development-environment/#step-1-start-a-new-smee-channel).
    * Вы [проверили сообщение электронной почты](#step-1-update-app-permissions) после обновления разрешений и приняли новые разрешения.

## Заключение

После прохождения этого руководства вы узнали об основных стандартных блоках для разработки приложений GitHub! Для этого вы:

* Запрограммировали приложение на ожидание передачи данных для событий.
* Использовали библиотеку Octokit.rb для выполнения операций REST API.

## Дальнейшие действия

Ниже приведены некоторые идеи о том, что еще можно сделать:

* [Перезаписать приложение с помощью GraphQL](https://developer.github.com/changes/2018-04-30-graphql-supports-github-apps/)!
* Перезаписать приложение в Node.js с помощью [Probot](https://github.com/probot/probot)!
* Убедиться, что в проблеме уже существует метка `needs-response`, а если нет, то добавить ее.
* Когда бот успешно добавит метку, отобразится сообщение в терминале. (Указание. Сравните идентификатор метки `needs-response` с идентификатором метки в полезных данных в качестве условия для сообщения, чтобы сообщение отображалось только при добавлении соответствующей метки, а не другой.)
* Добавьте целевую страницу в приложение и подключите для нее [маршрут Sinatra](https://github.com/sinatra/sinatra#routes).
* Переместите код на размещенный сервер (например, Heroku). Не забудьте обновить параметры приложения для нового домена.
* Поделитесь своим проектом или получите советы в {% данных reusables.support.prodname_support_forum_with_url %}{% ifversion fpt или ghec %}
* Создали ли вы блестящее новое приложение, которое, как вы считаете, может пригодиться другим? [Добавьте его в GitHub Marketplace](/apps/marketplace/creating-and-submitting-your-app-for-approval/)!{% endif %}
